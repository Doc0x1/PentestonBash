#!/bin/bash
# PentestonBash
# This plugin will set persistent environment variables for LHOST and RHOST to make ethical pentesting easier.

penteston() {
    # Determine the location of .bashrc
    BASHRC_LOCATION="$HOME/.bashrc"

    # Check if .bashrc exists
    if [ ! -f "$BASHRC_LOCATION" ]; then
        printf "Error: .bashrc not found at $BASHRC_LOCATION. Please create it first.\n"
        return 1
    fi

    # Initialize variables
    local NEW_LHOST=''
    local NEW_RHOST=''

    # Regex pattern for validating IP address
    local ip_regex='^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$'

    # Process arguments
    while [[ "$#" -gt 0 ]]; do
        case $1 in
            --lhost)
                NEW_LHOST=$2
                shift 2
                ;;
            --rhost)
                NEW_RHOST=$2
                shift 2
                ;;
            *)
                printf "This function will set persistent environment variables for LHOST and RHOST.\n"
                printf "Usage: penteston [--lhost <local_ip>] [--rhost <remote_ip>]\n"
                return 1
                ;;
        esac
    done

    # Default LHOST to tun0 IP if not provided
    if [[ -z "$NEW_LHOST" ]]; then
        if ip addr show tun0 &> /dev/null; then
            NEW_LHOST=$(ip -4 addr show tun0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
        else
            printf "Error: tun0 interface not found and no LHOST provided.\n"
            return 1
        fi
    fi

    # Update LHOST if valid
    if [[ -n "$NEW_LHOST" ]]; then
        if [[ "$NEW_LHOST" =~ $ip_regex ]]; then
            export LHOST=$NEW_LHOST
            if grep -q 'export LHOST=' "$BASHRC_LOCATION"; then
                sed -i "s/export LHOST=.*/export LHOST=$LHOST/" "$BASHRC_LOCATION"
            else
                echo "export LHOST=$LHOST" >>"$BASHRC_LOCATION"
            fi
            printf "Setting LHOST variable to $LHOST\n"
        else
            printf "Error: Invalid LHOST IP address format.\n"
            return 1
        fi
    elif [[ -z "$LHOST" ]]; then
        printf "Error: LHOST not provided and not currently set. Please specify --lhost.\n"
        return 1
    fi

    # Update RHOST if provided and valid
    if [[ -n "$NEW_RHOST" ]]; then
        if [[ "$NEW_RHOST" =~ $ip_regex ]]; then
            export RHOST=$NEW_RHOST
            if grep -q 'export RHOST=' "$BASHRC_LOCATION"; then
                sed -i "s/export RHOST=.*/export RHOST=$RHOST/" "$BASHRC_LOCATION"
            else
                echo "export RHOST=$RHOST" >>"$BASHRC_LOCATION"
            fi
            printf "Setting RHOST variable to $RHOST\n"
        else
            printf "Error: Invalid RHOST IP address format.\n"
            return 1
        fi
    elif [[ -z "$RHOST" ]]; then
        printf "Error: RHOST not provided and not currently set. Please specify --rhost.\n"
        return 1
    fi
    # If neither LHOST nor RHOST are provided, exit with an error
    if [[ -z "$NEW_LHOST" && -z "$NEW_RHOST" ]]; then
        printf "Error: Neither LHOST nor RHOST provided. Please specify at least one.\n"
        return 1
    fi

    printf "Pentest variables updated.\n"
    printf "Pentesting Environment now online.\n"
}


#$ Use this function when done with the pentest.
pentestoff() {
    # Determine the location of .bashrc
    BASHRC_LOCATION="$HOME/.bashrc"

    # Check if .bashrc exists
    if [ ! -f "$BASHRC_LOCATION" ]; then
        printf "Error: .bashrc not found at $BASHRC_LOCATION.\n"
        return 1
    fi

    printf "This function will unset the LHOST and RHOST variables and remove them from $BASHRC_LOCATION.\n"
    printf "Use it when you are finished pentesting.\n"

    # Unset variables and remove from .bashrc
    unset LHOST RHOST
    sed -i '/export LHOST=/d' "$BASHRC_LOCATION"
    sed -i '/export RHOST=/d' "$BASHRC_LOCATION"
    printf "Unset LHOST and RHOST variables and removed them from $BASHRC_LOCATION\n"
    printf "Pentesting Environment now offline.\n"
}
